<!DOCTYPE html>
  <html>
  
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
      <script type="text/javascript" src="http://test.oainsight.zebra-c.com/lib/core/jquery-1.10.2.min.js?_=1517278420871"></script>
      <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=c9VzBGjpGifxq4HPKdyXHWxErdqpcI74"></script>
      <script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
      <title id="titlePage"></title>
      <script type="text/javascript" src="./data/allData.js"></script>
      <script type="text/javascript" src="./data/config.js"></script>
      <script type="text/javascript" src="./data/pointer.js"></script>
      <style type="text/css">
      ul,
      li {
          list-style: none;
          margin: 0;
          padding: 0;
          float: left;
      }
      
      html {
          height: 100%
      }
      
      body {
          height: 100%;
          margin: 0px;
          padding: 0px;
          font-family: "微软雅黑";
      }
      .cell {
          padding:0 6px;
      }
      #container {
          height: 550px;
          width: 98%;
      }
      
      #r-result {
          width: 100%;
          padding-bottom: 50px;
      }
      #pageTopTitle{
          position: fixed;
          left:10px;
          right:10px;
          z-index: 1;
          color:#666;
          font-size:20px;
      }
      </style>
  </head>
  
  <body>
      <h3 id="pageTopTitle"></h3>
      <div id="container">
      </div>
      <div id="r-result">
          <input type="number" id="maxValueJuzhu" placeholder="热力图权重"></input>
          <button id="showHeatMapBtn">显示热力图</button>
          <button id="hideHeatMapBtn">关闭热力图</button>
          <button id="showMarkerBtn">显示点</button>
          <button id="hideMarkerBtn">隐藏点</button>
          <div class="input-wrap" id="inputWrap"></div>
      </div>
  </body>
  
  </html>
  <script type="text/javascript">
var ObjeHandler = {
    init(){
        this.createIpt()
        this.action()
        this.setTitle('广州-总体')
        this.setMapALL()
        this.markerGroup = []
        this.getMarker()
    },
    getMarker() {
        let normal = this.addPointer(POINTER.normal, MARKER_ICON.blue, 32, true)
        let all = this.addPointer(POINTER.all, MARKER_ICON.lightBlue, 16)
        this.markerGroup = [...normal, ...all]
    },
    setTitle(name) {
        document.querySelector("#titlePage").innerText = name
        document.querySelector("#pageTopTitle").innerText = name
    },
    setMapALL () {
        let _arr = []
        originObj.map(item => {
            Object.keys(item.heatMap).map(i => {
                _arr.push(...item.heatMap[i])
            })
        })
        console.log(_arr.length)
        heatmapOverlay.setDataSet({
            data: this.getPointes(_arr),
            max:$('#maxValueJuzhu').val()
        });
    },
    setMapABCD (index) {
        var mapDataHeatMap = originObj[index].heatMap
        let _arr = []
        Object.keys(mapDataHeatMap).map(item => {
            _arr.push(...mapDataHeatMap[item])
        })
        heatmapOverlay.setDataSet({
            data: this.getPointes(_arr),
            max:$('#maxValueJuzhu').val()
        });
    },
    setMap (index, type) {
        console.log(index, type)
        var data = originObj[index].heatMap[type]
        heatmapOverlay.setDataSet({
            data: this.getPointes(data),
            max:$('#maxValueJuzhu').val()
        });
    },
    getPointes (heatData) {
        var points = []
        for (var i = 0, len = heatData.length; i < len; i++) {
            var temp = heatData[i];
            var obj = {
                lng: temp[0],
                lat: temp[1],
                count: temp[2],
            }
            points.push(obj);
        }
        return points
    },
    action () {
        var _this = this
        $("#inputWrap").on('click', '.ipt', function() {
            var index = $(this).attr('data-index')
            var type = $(this).attr('data-type')
            var name = $(this).val()
            _this.setTitle(name)
            if (type === 'all') {
                _this.setMapALL()
            } else if (type === 'ABCD') {
                _this.setMapABCD(index)
            } else {
                _this.setMap(index, type)
            }
            heatmapOverlay.show();
        })
        $('#showMarkerBtn').on('click', function(){
            _this.showMarker()
        })
        $('#hideMarkerBtn').on('click', function(){
            _this.hideMarker()
        })
        $('#hideHeatMapBtn').on('click', function(){
            _this.hideHeatMap()
        })
        $('#showHeatMapBtn').on('click', function(){
            _this.showHeatMap()
        })
        
    },
    createIpt () {
        var btnStr = `<input class="ipt" data-type="all" type="button" value="总体"></input><span class="cell"></span><br/>`
        $('#inputWrap').append(btnStr);
    },
    addPointer(data, icon, size, action) {
        var myIcon = new BMap.Icon(icon, new BMap.Size(size, size));
        var pointArray = []
        let markerGroup = []
	    for(var i=0;i<data.length;i++){
            var marker = new BMap.Marker(new BMap.Point(data[i][0], data[i][1]), {icon: myIcon}); // 创建点
            markerGroup.push(marker)
            map.addOverlay(marker);    //增加点
            // pointArray[i] = new BMap.Point(data[i][0], data[i][1]);
            action === true && this.markerAction(marker, data[i][2])
        }
        return markerGroup
        // this.showMarker()
	    // //让所有点在视野范围内
	    // map.setViewport(pointArray);
    },
    showMarker(){
        this.markerGroup.map(item => {
            item.show()
        })
    },
    hideMarker(){
        this.markerGroup.map(item => {
            item.hide()
        })
    },
    markerAction(marker, text) {
        marker.addEventListener("mouseover",function(e){
            var label = new BMap.Label(text,{offset:new BMap.Size(15,-35)});//为标注设置一个标签
            label.setStyle({
                width: "180px",
                color: '#fff',
                background: '#000',
                opacity: '.8',
                border: '1px solid "#000"',
                borderRadius: "5px",
                textAlign: "center",
                height: "26px",
                lineHeight: "26px"
            });
            marker.setLabel(label);
        });
        marker.addEventListener("mouseout",function(e){  
            var label = this.getLabel();
            label.setContent("");//设置标签内容为空
            label.setStyle({border:"none",width:"0px",padding:"0px"});//设置标签边框宽度为0
        });
    },
    hideHeatMap () {
        heatmapOverlay.hide();
    },
    showHeatMap () {
        heatmapOverlay.show();
    }
}

  var pointer = {
    lng: '113.253607',
    lat: '23.145173',
  }
  
  var map = new BMap.Map("container"); // 创建地图实例
  var point = new BMap.Point(pointer.lng,pointer.lat); //初始化北京地图，设置中心点坐标和地图级别
  map.centerAndZoom(point, 12.4);
  map.enableScrollWheelZoom(); // 允许滚轮缩放
  if (!isSupportCanvas()) {
      alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
  }
  var heatmapOverlay = new BMapLib.HeatmapOverlay({
     "radius": 20,
  });
  map.addOverlay(heatmapOverlay);
  map.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL})); 
  heatmapOverlay.show();

  //判断浏览区是否支持canvas
function isSupportCanvas() {
    var elem = document.createElement('canvas');
    return !!(elem.getContext && elem.getContext('2d'));
}

window.onload=function(){
    ObjeHandler.init()
}
  
  </script>
  